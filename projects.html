<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Projects — Buzurg Saim</title>

  <style>
    :root {
      --bg: #f6f3ee;
      --panel: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --border: #e5e1d8;
      --accent: #8b5e34;
      --shadow: 0 10px 30px rgba(0,0,0,0.08);
      --radius: 18px;
      --max: 1000px;
    }

    body {
      margin: 0;
      font: 16px/1.55 ui-sans-serif, system-ui;
      background: var(--bg);
      color: var(--text);
    }

    .wrap {
      max-width: var(--max);
      margin: 0 auto;
      padding: 40px 20px 80px;
    }

    h1 {
      margin-bottom: 20px;
    }
    .card {
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      border: 1px solid var(--border);
      overflow-x: auto;
    }

    h2 {
      margin: 28px 0 12px;
      font-size: 18px;
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
      margin: 0 0 12px;
    }

    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #faf8f4;
      font-size: 12px;
      font-weight: 600;
    }


    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      border: 1px solid var(--border);
      padding: 14px;
      text-align: left;
      font-size: 14px;
    }

    th {
      background: #faf8f4;
      font-weight: 600;
    }

    tr:hover {
      background: #fdfaf6;
    }

    .btn {
      display: inline-block;
      margin-top: 20px;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #ffffff;
      text-decoration: none;
      color: var(--text);
    }

    .btn:hover {
      background: #faf8f4;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <a class="btn" href="index.html">← Back to Home</a>

    <h1>Earnings Reports This Week</h1>

    <h2>Earnings Reports This Week (FMP)</h2>
    <p class="muted">
      Live data loaded from <span class="pill">https://financialmodelingprep.com/stable/earnings-calendar</span>
      <br />
      Click <span class="pill">Load</span> to pull the latest earnings calendar onto this page.
    </p>

    <div class="card" style="margin-bottom: 28px;">
      <div style="display:flex; gap: 10px; align-items:center; flex-wrap: wrap; margin-bottom: 12px;">        <label for="range-preset" class="muted" style="margin:0;">Range:</label>
        <select id="range-preset" style="padding:10px 12px; border-radius: 12px; border: 1px solid var(--border); background:#fff;">
          <option value="this_week" selected>This week</option>
          <option value="next_week">Next week</option>
          <option value="last_week">Last week</option>
          <option value="this_month">This month</option>
          <option value="custom">Custom dates</option>
        </select>

        <label for="from-date" class="muted" style="margin:0;">From:</label>
        <input id="from-date" type="date" style="padding:10px 12px; border-radius: 12px; border: 1px solid var(--border);" />

        <label for="to-date" class="muted" style="margin:0;">To:</label>
        <input id="to-date" type="date" style="padding:10px 12px; border-radius: 12px; border: 1px solid var(--border);" />

        <button id="load-earnings" class="btn" type="button" style="margin-top:0; cursor:pointer;">Load</button>

        <label class="muted" style="margin:0; display:flex; align-items:center; gap:8px;">
          <input id="use-confirmed" type="checkbox" style="transform: translateY(1px);" />
          Use Confirmed (includes time)
        </label>

        <span id="earnings-range" class="pill">—</span>
      </div>

      <table aria-describedby="earnings-caption">
        <caption id="earnings-caption" style="text-align:left; padding: 0 0 10px; color: var(--muted); font-size: 13px;">
          Tip: The <span class="pill">stable/earnings-calendar</span> endpoint may not include exact release time. Try <span class="pill">Confirmed</span> for timing when available.
        </caption>
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Date</th>
            <th>Time</th>
            <th>EPS Est.</th>
            <th>EPS Actual</th>
            <th>Revenue Est.</th>
            <th>Revenue Actual</th>
          </tr>
        </thead>
        <tbody id="earnings-body">
          <tr><td colspan="7">Choose a range and click “Load”.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const FMP_API_KEY = 'RH5ljVUrh5z4Gy0fc4qOvfYFPXMbkvTi';

    function fmtDate(x) {
      const yyyy = x.getFullYear();
      const mm = String(x.getMonth() + 1).padStart(2, '0');
      const dd = String(x.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function startOfWeekMonday(date = new Date()) {
      const d = new Date(date);
      const day = d.getDay(); // 0=Sun, 1=Mon...
      const diffToMonday = (day === 0 ? -6 : 1 - day);
      const monday = new Date(d);
      monday.setDate(d.getDate() + diffToMonday);
      monday.setHours(0, 0, 0, 0);
      return monday;
    }

    function endOfWeekSunday(monday) {
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      sunday.setHours(23, 59, 59, 999);
      return sunday;
    }

    function startOfMonth(date = new Date()) {
      const d = new Date(date);
      d.setDate(1);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function endOfMonth(date = new Date()) {
      const d = new Date(date);
      d.setMonth(d.getMonth() + 1);
      d.setDate(0); // last day of previous month
      d.setHours(23, 59, 59, 999);
      return d;
    }

    function getRangeFromPreset(preset) {
      const now = new Date();

      if (preset === 'this_week') {
        const mon = startOfWeekMonday(now);
        return { from: fmtDate(mon), to: fmtDate(endOfWeekSunday(mon)) };
      }

      if (preset === 'next_week') {
        const mon = startOfWeekMonday(now);
        mon.setDate(mon.getDate() + 7);
        return { from: fmtDate(mon), to: fmtDate(endOfWeekSunday(mon)) };
      }

      if (preset === 'last_week') {
        const mon = startOfWeekMonday(now);
        mon.setDate(mon.getDate() - 7);
        return { from: fmtDate(mon), to: fmtDate(endOfWeekSunday(mon)) };
      }

      if (preset === 'this_month') {
        return { from: fmtDate(startOfMonth(now)), to: fmtDate(endOfMonth(now)) };
      }

      return null; // custom handled elsewhere
    }

    function setCustomInputsEnabled(enabled) {
      const fromEl = document.getElementById('from-date');
      const toEl = document.getElementById('to-date');
      if (fromEl) fromEl.disabled = !enabled;
      if (toEl) toEl.disabled = !enabled;
      if (fromEl) fromEl.style.opacity = enabled ? '1' : '0.6';
      if (toEl) toEl.style.opacity = enabled ? '1' : '0.6';
    }

    function getSelectedRange() {
      const presetEl = document.getElementById('range-preset');
      const fromEl = document.getElementById('from-date');
      const toEl = document.getElementById('to-date');

      const preset = presetEl?.value || 'this_week';

      if (preset !== 'custom') {
        const r = getRangeFromPreset(preset);
        if (!r) return null;
        // reflect in inputs for clarity
        if (fromEl) fromEl.value = r.from;
        if (toEl) toEl.value = r.to;
        return r;
      }

      const from = (fromEl?.value || '').trim();
      const to = (toEl?.value || '').trim();
      if (!from || !to) return null;
      if (from > to) return null;
      return { from, to };
    }

    async function loadEarnings() {
      const tbody = document.getElementById('earnings-body');
      const rangeEl = document.getElementById('earnings-range');
      const presetEl = document.getElementById('range-preset');

      if (!tbody) return;

      const apiKey = (FMP_API_KEY || '').trim();
      if (!apiKey) {
        tbody.innerHTML = '<tr><td colspan="7">Missing API key.</td></tr>';
        return;
      }

      const range = getSelectedRange();
      const preset = presetEl?.value || 'this_week';
      if (!range) {
        tbody.innerHTML = preset === 'custom'
          ? '<tr><td colspan="7">Please choose valid From/To dates (From must be ≤ To).</td></tr>'
          : '<tr><td colspan="7">Could not determine date range.</td></tr>';
        return;
      }

            if (rangeEl) rangeEl.textContent = `${range.from} → ${range.to}`;

      const useConfirmed = !!document.getElementById('use-confirmed')?.checked;
      const base = useConfirmed
        ? 'https://financialmodelingprep.com/api/v4/earning-calendar-confirmed'
        : 'https://financialmodelingprep.com/stable/earnings-calendar';

      const url = `${base}?from=${range.from}&to=${range.to}&apikey=${encodeURIComponent(apiKey)}`;

      tbody.innerHTML = '<tr><td colspan="7">Loading…</td></tr>';

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const rows = await res.json();
        if (!Array.isArray(rows) || rows.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7">No earnings found for the selected range.</td></tr>';
          return;
        }

        const money = (v) => {
          if (v === null || v === undefined || v === '') return '—';
          const num = Number(v);
          if (Number.isNaN(num)) return String(v);
          return Intl.NumberFormat(undefined, { notation: 'compact', maximumFractionDigits: 2 }).format(num);
        };

        const numOrDash = (v) => (v === null || v === undefined || v === '' ? '—' : v);

        tbody.innerHTML = rows
          .slice()
          .sort((a, b) => String(a.date || '').localeCompare(String(b.date || '')))
          .map((r) => {
            const symbol = r.symbol ?? '—';
            const date = r.date ?? '—';
            const time = r.time ?? r.hour ?? r.timing ?? r.when ?? '—';
            const epsEst = r.epsEstimated ?? r.eps_estimated ?? r.epsEstimate ?? r.eps_estimate;
            const epsAct = r.eps ?? r.epsActual ?? r.eps_actual;
            const revEst = r.revenueEstimated ?? r.revenue_estimated ?? r.revenueEstimate ?? r.revenue_estimate;
            const revAct = r.revenue ?? r.revenueActual ?? r.revenue_actual;

            return `
              <tr>
                <td>${symbol}</td>
                <td>${date}</td>
                <td>${time}</td>
                <td>${numOrDash(epsEst)}</td>
                <td>${numOrDash(epsAct)}</td>
                <td>${money(revEst)}</td>
                <td>${money(revAct)}</td>
              </tr>
            `;
          })
          .join('');
      } catch (err) {
        const msg = err && err.message ? err.message : String(err);
        tbody.innerHTML = `<tr><td colspan="7">Failed to load earnings data. ${msg}</td></tr>`;
      }
    }

    function initEarningsUI() {
      
      const btn = document.getElementById('load-earnings');
      const rangeEl = document.getElementById('earnings-range');
      const presetEl = document.getElementById('range-preset');
      const fromEl = document.getElementById('from-date');
      const toEl = document.getElementById('to-date');

      // Default range values
      const initial = getRangeFromPreset('this_week');
      if (initial) {
        if (fromEl) fromEl.value = initial.from;
        if (toEl) toEl.value = initial.to;
        if (rangeEl) rangeEl.textContent = `${initial.from} → ${initial.to}`;
      }

      setCustomInputsEnabled(false);

      if (btn) btn.addEventListener('click', loadEarnings);

      const confirmedToggle = document.getElementById('use-confirmed');
      if (confirmedToggle) {
        confirmedToggle.addEventListener('change', () => {
          loadEarnings();
        });
      }

      if (presetEl) {
        presetEl.addEventListener('change', () => {
          const preset = presetEl.value;
          const isCustom = preset === 'custom';
          setCustomInputsEnabled(isCustom);

          if (!isCustom) {
            const r = getRangeFromPreset(preset);
            if (r) {
              if (fromEl) fromEl.value = r.from;
              if (toEl) toEl.value = r.to;
              if (rangeEl) rangeEl.textContent = `${r.from} → ${r.to}`;
              loadEarnings();
            }
          } else {
            if (rangeEl) rangeEl.textContent = 'Custom range';
          }
        });
      }

      // If user edits custom dates, don't auto-load unless they click Load.
      // But we keep the pill updated.
      const updatePill = () => {
        const r = getSelectedRange();
        if (presetEl?.value === 'custom') {
          if (rangeEl) rangeEl.textContent = r ? `${r.from} → ${r.to}` : 'Custom range';
        }
      };
      if (fromEl) fromEl.addEventListener('change', updatePill);
      if (toEl) toEl.addEventListener('change', updatePill);
    }

    document.addEventListener('DOMContentLoaded', initEarningsUI);
  </script>
</body>
</html>

